(function(){var W=[].indexOf||function(a){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===a)return i}return-1};amp.plugin('appInsights',function(g){var h=this;var j=0.1;var k;if(g==null){g={}}var l={};if(this.options()["data-setup"]){k=JSON.parse(this.options()["data-setup"]);if(k.ga){l=k.ga}}appInsights.config.maxBatchInterval=sendInterval=g.sendInterval||l.sendInterval||15;appInsights.config.disableFlushOnBeforeUnload=true;var m=['playbackSummary'];var n=g.metricsToTrack||l.metricsToTrack||m;var o={};n.forEach(function(a,b,c){o[a]=true});var p=g.percentsPlayedInterval||l.percentsPlayedInterval||20;g.debug=g.debug||false;var q=g.Tenant;var r=g.PanelId;var s=g.PanelTitle;if(g.userId||l.userId){var t=g.userId||l.userId;var u=g.accountId||l.accountId||null;appInsights.setAuthenticatedUserContext(t,u);if(g.debug){console.log("Authenticated User Context set as userId: "+t+" and accountId: "+u)}}var v=g.streamId||l.streamId||null;var w=g.trackSdn||l.trackSdn||false;var x=[];var y=-1;var z=0;var A=false;var B=null;function mapManifestUrlToId(a){var b="unknown";if(a){b=a.split("//")[1];if(b.match(/.ism\/manifest/i)){b=b.split(/.ism\/manifest/i)[0]+".ism/manifest"}}return b}function mapProtectionInfo(a){var b="unknown";if(a){switch(a.toLowerCase()){case"aes":b="aes";break;case"playready":b="drm";break;case"widevine":b="drm";break;case"fairplay":b="drm";break;default:b="none"}}return b}function calculateBufferAhead(){var a=myPlayer.buffered();var b=myPlayer.currentTime();if(!a){return undefined}return Math.max(0,a.end(a.length-1)-b)}var C={loadTime:0,loadTimeStart:new Date().getTime(),firstPlay:false,endedReached:false,videoElementUsed:false,unloaddatasent:false,updateLoadTime:function(){this.loadTime=Math.abs(new Date().getTime()-this.loadTimeStart);if(g.debug){console.log("Player Load Time determined: "+this.loadTime+"ms")}this.send()},send:function(){if(o.loaded){if(this.loadTime<100000){V("loadTime",{"time":this.loadTime})}}},reset:function(){this.loadTime=0;this.loadTimeStart=new Date().getTime();this.firstPlay=false;this.endedReached=false;var a=g.streamId||l.streamId||null}}var D={state:false,bufferingTime:0,bufferingTimeStart:0,bufferingTimeTotal:0,count:0,enterBuffering:function(){if(C.firstPlay){this.bufferingTimeStart=new Date().getTime();this.state=true;this.count++;if(g.debug){console.log("Entering buffering state...")}}},send:function(){if(this.state){this.bufferingTime=Math.abs(new Date().getTime()-this.bufferingTimeStart);var a=Math.round(h.currentTime());if(a!==0){if(o.buffering){bufferingMetrics={'currentTime':a,'bufferingTime':this.bufferingTime,};if(E.videoBuffer){bufferingMetrics.perceivedBandwidth=E.videoBuffer.perceivedBandwidth}if(calculateBufferAhead){bufferingMetrics.buffered=calculateBufferAhead}V('buffering',bufferingMetrics)}}this.bufferingTimeTotal+=this.bufferingTime;this.state=false;if(g.debug){console.log("Exiting buffering state.  Time spent rebuffering was "+this.bufferingTime+"ms")}}},reset:function(){this.bufferingTime=0;this.state=false},fullReset:function(){this.bufferingTime=0;this.bufferingTimeStart=0;this.bufferingTimeTotal=0;this.count=0;this.state=false}}var E={videoBuffer:null,audioBuffer:null,sumBitrate:0,sumPerceivedBandwidth:0,sumMeasuredBandwidth:0,downloadedChunks:0,failedChunks:0,completed:function(){if(h.currentDownloadBitrate()){this.downloadedChunks+=1;this.sumBitrate+=h.currentDownloadBitrate();if(this.videoBuffer){if(o.downloadInfo){V("downloadCompleted",{"bitrate":h.currentDownloadBitrate(),"measuredBandwidth":this.videoBuffer.downloadCompleted.measuredBandwidth,"perceivedBandwidth":this.videoBuffer.perceivedBandwidth})}this.sumPerceivedBandwidth+=this.videoBuffer.perceivedBandwidth;this.sumMeasuredBandwidth+=this.videoBuffer.downloadCompleted.measuredBandwidth}}},failed:function(a){if(o.downloadInfo){if(a.toLowerCase()=="audio"){var b=0;var c=this.audioBuffer.downloadFailed.code.toString(8)}else{var b=1;var c=this.videoBuffer.downloadFailed.code.toString(8)}V("downloadFailed",{"isVideo":b,"error":c})}this.failedChunks++},send:function(){if(o.bitrateQuality){if(this.downloadedChunks>0){bitrateQualityMetrics={"avgBitrate":this.sumBitrate/this.downloadedChunks}if(this.videoBuffer){var a=Math.round(this.sumMeasuredBandwidth/this.downloadedChunks);var b=Math.round(this.sumPerceivedBandwidth/this.downloadedChunks);bitrateQualityMetrics.avgMeasuredBandwidth=a;bitrateQualityMetrics.avgPerceivedBandwidth=b}V("bitrateQuality",bitrateQualityMetrics)}}},reset:function(){this.videoBuffer=null;this.audioBuffer=null;this.sumBitrate=0;this.sumPerceivedBandwidth=0;this.sumMeasuredBandwidth=0;this.downloadedChunks=0;this.failedChunks=0}}var F={startTime:0,endTime:0,added:false,lastCheckedTime:0,arrayOfTimes:[],overlappingArrayOfTimes:[],sorted:false,totalSecondsFullscreen:0,sortAlgorithm:function(a,b){if(a[0]<b[0])return-1;if(a[0]>b[0])return 1;return 0},update:function(a){if(a==this.lastCheckedTime+1){if(h.isFullscreen()){this.totalSecondsFullscreen+=1}}if(!(a==this.lastCheckedTime||a==this.lastCheckedTime+1)){this.endTime=this.lastCheckedTime;this.push();this.startTime=a;this.added=false}this.lastCheckedTime=a},push:function(){this.arrayOfTimes.push([this.startTime,this.endTime]);this.added=true},getOverlappingArrayOfTimes:function(){if(!this.added){this.endTime=Math.round(h.currentTime());this.push()}this.arrayOfTimes=this.arrayOfTimes.sort(this.sortAlgorithm);if(this.arrayOfTimes.length>1){this.overlappingArrayOfTimes.push(this.arrayOfTimes[0]);for(var i=1;i<this.arrayOfTimes.length;i++){if(this.arrayOfTimes[i][0]<=this.overlappingArrayOfTimes[this.overlappingArrayOfTimes.length-1][1]){if(this.arrayOfTimes[i][1]>this.overlappingArrayOfTimes[this.overlappingArrayOfTimes.length-1][1]){var a=this.overlappingArrayOfTimes[this.overlappingArrayOfTimes.length-1][0];var b=this.arrayOfTimes[i][1];this.overlappingArrayOfTimes.pop();this.overlappingArrayOfTimes.push([a,b])}}else{this.overlappingArrayOfTimes.push(this.arrayOfTimes[i])}}}else{this.overlappingArrayOfTimes=this.arrayOfTimes}this.sorted=true},getTotalPlayTime:function(){if(!this.sorted){this.getOverlappingArrayOfTimes()}var a=0;for(var i=0;i<this.arrayOfTimes.length;i++){a+=this.arrayOfTimes[i][1]-this.arrayOfTimes[i][0]}return Math.round(a)},getTotalUniquePlayTime:function(){if(!this.sorted){this.getOverlappingArrayOfTimes()}var a=0;for(var i=0;i<this.overlappingArrayOfTimes.length;i++){a+=this.overlappingArrayOfTimes[i][1]-this.overlappingArrayOfTimes[i][0]}return Math.round(a)},reset:function(){this.startTime=0;this.endTime=0;this.totalSecondsFullscreen=0;this.added=false;this.sorted=false;this.arrayOfTimes=[];this.overlappingArrayOfTimes=[]}};var G={totalSeconds:0,totalSecondsFullscreen:0,start:function(){var a=this;this.interval=setInterval(function(){a.totalSeconds+=1;if(h.isFullscreen()){a.totalSecondsFullscreen+=1}},1000)},pause:function(){clearInterval(this.interval);delete this.interval},resume:function(){if(!this.interval)this.start()},send:function(){V('playTime',{"time":this.totalSeconds})},reset:function(){this.totalSeconds=0;this.totalSecondsFullscreen=0}};var H=function(){if(C.videoElementUsed){unloadData()}C.reset()D.fullReset();G.reset();F.reset();E.reset();z=0;y=null;B=null;v=null;if(g.debug){console.log("Resetting App Insight Plugin Config")}}var I=function(){v=g.streamId||l.streamId||null;if(!v){v=mapManifestUrlToId(h.currentSrc())}if(g.debug){console.log("streamId set as: "+v)}if(h.currentProtectionInfo()){B=mapProtectionInfo(h.currentProtectionInfo()[0].type)}else{B="none"}if(g.debug){console.log("protectionInfo set as: "+B)}if(o.loaded){V('loadedmetadata')}C.videoElementUsed=true};var J=function(){C.updateLoadTime()}var K=function(){if(v){var a=Math.round(h.currentTime());if(o.playbackSummary||o.playTime){F.update(a)}if(o.percentsPlayed){if(!this.isLive()){var b=Math.round(h.duration());var c=Math.round(a/b*100);if(c!=y){if(c%p==0&&c<=100){if(W.call(x,c)<0){if(c!==0){z+=p}x.push(c)}V("percentReached",{"percent":c})}}y=c}}if(o.bitrateQuality||o.playbackSummary){if(!E.videoBuffer&&h.currentDownloadBitrate()){E.completed()}}}};var L=function(){if(o.play){var a;a=Math.round(h.currentTime());V('play',{'currentTime':a})}};var M=function(){A=false;if(!C.firstPlay){if(o.viewed){V("viewed")}C.firstPlay=true}if(o.buffering||o.playbackSummary){D.send()}if(o.playTime||o.playbackSummary){if(h.isLive()){if(G.totalSeconds==0){G.start()}else{G.resume()}}}}var N=function(){if(o.playTime||o.playbackSummary){if(h.isLive()){G.pause()}}if(o.pause){var a=Math.round(h.currentTime());var b=Math.round(h.duration());if(a!==b&&!A){if(o.pause){V('pause',{'currentTime':a})}}}}var O=function(){A=true;if(o.seek){var a=Math.round(h.currentTime());V('seek',{'currentTime':a})}}var P=function(){if(o.playTime||o.playbackSummary){if(h.isLive()){G.pause()}}if(o.ended){if(!C.endedReached){V('ended');C.endedReached=true}}};var Q=function(){D.enterBuffering()}var R=function(){E.completed()}var S=function(){}var T=function(){var a=Math.round(h.currentTime());if((typeof h.isFullscreen==="function"?h.isFullscreen():void 0)||(typeof h.isFullScreen==="function"?h.isFullScreen():void 0)){V('fullscreen',{'enter':1,'currentTime':a})}else{V('fullscreen',{'enter':0,'currentTime':a})}};var U=function(){if(C.loadTime==0){C.updateLoadTime()}if(o.playTime||o.playbackSummary){if(h.isLive()){G.pause()}}if(o.error){var a=Math.round(h.currentTime());var b=h.error().code.toString(16);V("error",{"code":b,'currentTime':a})}};function exit(){if(!C.unloaddatasent){C.unloaddatasent=true;unloadData()}};function unloadData(){var a=G.totalSeconds;var b=G.totalSecondsFullscreen;var c=Math.min(z,100);if(!h.isLive()){a=F.getTotalPlayTime();b=F.totalSecondsFullscreen;c=Math.min(Math.round((F.getTotalUniquePlayTime()/h.duration())*100),100)}if(C.loadTime==0){C.updateLoadTime()}if(D.state){D.send()}if(o.playTime){G.send()}if(o.percentsPlayed){if(!h.isLive()){V("percentPlayed",{"percentage":z})}}if(o.bitrateQuality){E.send()}if(o.buffering){V('rebufferTime',{'count':D.count,"totalRebufferTime":D.bufferingTimeTotal})}if(o.playbackSummary){var d={"playTime":a,"fullscreenTime":b,"rebufferCount":D.count,"rebufferTime":D.bufferingTimeTotal}if(C.loadTime<=100000){d.loadTime=C.loadTime}if(!h.isLive()){d.percentPlayed=c}if(E.downloadedChunks>0){var e=Math.round(E.sumBitrate/E.downloadedChunks);d.avgBitrate=e}if(E.videoBuffer){d.failedDownloads=E.failedChunks}if(h.error()){d.errorCode=h.error().code.toString(16)}V("playbackSummary",d)}appInsights.flush()}var V=function(a,b){if(window.appInsights){var c={StreamId:v||"unknown",PluginVersion:j,PlayerVersion:h.getAmpVersion()||"unknown",PlaybackTech:h.currentTechName()||"unknown",MimeType:h.currentType()||"unknown",ProtectionType:B||"unknown",isLive:h.isLive()?"live":"vod"||"unknown",Tenant:g.Tenant||"unknown",PanelId:g.PanelId||"unknown",PanelTitle:g.PanelTitle||"unknown"};if(!v){var d="unknown";if(h.options_.sourceList[0]){d=h.options_.sourceList[0].src.split("//")[1];if(d.match(/.ism\/manifest/i)){d=d.split(/.ism\/manifest/i)[0]+".ism/manifest"}}c.StreamId=d}if(!B){var e="unknown";if(h.options_.sourceList[0]){if(h.options_.sourceList[0].protectionInfo){e=mapProtectionInfo(h.options_.sourceList[0].protectionInfo[0].type)}else{e="none"}}c.ProtectionType=e}if(w){c.Sdn=h.options_.sdn.name||"none"}var f=b||{};appInsights.trackEvent(a,c,f);if(g.debug){console.log("sent to Application Insights...'event': "+a+"\n'properties': "+JSON.stringify(c)+"\n'metrics': "+JSON.stringify(f))}if(a=="error"){c.errorMessage=h.error().message;appInsights.trackTrace(a,c,f);if(g.debug){console.log("sent to Application Insights Error Trace...'message': "+a+"\n'properties': "+JSON.stringify(c)+"\n'metrics': "+JSON.stringify(f))}}}else if(g.debug){console.log("App Insights not detected")}}h.addEventListener("sourceset",H);h.addEventListener("loadedmetadata",I);h.addEventListener("canplaythrough",J);if(o.bitrateQuality||o.downloadInfo||o.playbackSummary){h.addEventListener("loadedmetadata",function(){E.videoBuffer=h.videoBufferData();if(E.videoBuffer){E.videoBuffer.addEventListener("downloadcompleted",function(){E.completed()});E.videoBuffer.addEventListener("downloadfailed",function(){E.failed("video")})}E.audioBuffer=h.audioBufferData();if(E.audioBuffer){E.audioBuffer.addEventListener("downloadfailed",function(){E.failed("audio")})}})}if(o.percentsPlayed||o.bitrateQuality||o.playbackSummary||o.playTime){h.addEventListener("timeupdate",K)}h.addEventListener("playing",M);if(o.playTime||o.bitrateQuality||o.playbackSummary){window.addEventListener("onbeforeunload",exit,false);window.addEventListener("pagehide",exit,false);h.tempDispose=h.dispose;h.dispose=function(){unloadData();h.tempDispose()}}if(o.error||o.playTime||o.playbackSummary){h.addEventListener("error",U)}if(o.end||o.playTime||o.playbackSummary){h.addEventListener("ended",P)}if(o.play){h.addEventListener("play",L)}if(o.pause||o.playTime||o.buffering||o.playbackSummary){h.addEventListener("pause",N)}if(o.buffering||o.playbackSummary){h.addEventListener("waiting",Q)}if(o.buffering||o.seek||o.playbackSummary){h.addEventListener("seeked",O)}if(o.fullscreen){h.addEventListener("fullscreenchange",T)}})}).call(this);